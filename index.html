<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B5A2B">
    <title>Autumn's Ferret Farm</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        :root {
            --farm-brown: #8B5A2B;
            --farm-tan: #D2B48C;
            --farm-cream: #FFF8DC;
            --grass-green: #7CB342;
            --sky-blue: #87CEEB;
            --heart-red: #E74C3C;
            --energy-yellow: #F1C40F;
            --health-green: #2ECC71;
            --hunger-orange: #E67E22;
            --soil-brown: #5D4037;
            --wood-brown: #6D4C41;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(180deg, var(--sky-blue) 0%, #B3E5FC 40%, var(--grass-green) 40%, #558B2F 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .clouds {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .cloud {
            position: absolute;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            animation: float-cloud linear infinite;
        }

        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
        }

        .cloud:nth-child(1) { width: 80px; height: 35px; top: 8%; animation-duration: 40s; }
        .cloud:nth-child(1)::before { width: 45px; height: 45px; top: -22px; left: 12px; }
        .cloud:nth-child(1)::after { width: 55px; height: 50px; top: -28px; left: 38px; }

        .cloud:nth-child(2) { width: 60px; height: 28px; top: 18%; animation-duration: 50s; animation-delay: -20s; }
        .cloud:nth-child(2)::before { width: 35px; height: 35px; top: -18px; left: 8px; }
        .cloud:nth-child(2)::after { width: 40px; height: 38px; top: -20px; left: 28px; }

        .cloud:nth-child(3) { width: 100px; height: 40px; top: 5%; animation-duration: 60s; animation-delay: -35s; }
        .cloud:nth-child(3)::before { width: 55px; height: 55px; top: -28px; left: 18px; }
        .cloud:nth-child(3)::after { width: 60px; height: 58px; top: -35px; left: 50px; }

        @keyframes float-cloud {
            from { left: -120px; }
            to { left: 100vw; }
        }

        .sun {
            position: fixed;
            top: 15px;
            right: 20px;
            width: 70px;
            height: 70px;
            background: radial-gradient(circle, #FFE082 0%, #FFB300 100%);
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(255, 179, 0, 0.6);
            z-index: 0;
            animation: pulse-sun 3s ease-in-out infinite;
        }

        @keyframes pulse-sun {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .game-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--wood-brown) 0%, var(--farm-brown) 100%);
            border-radius: 18px;
            padding: 12px 18px;
            margin-bottom: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.15);
            border: 4px solid #4E342E;
            text-align: center;
        }

        .header h1 {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.8rem;
            color: var(--farm-cream);
            text-shadow: 2px 2px 0 #4E342E;
        }

        .header .subtitle {
            font-size: 0.85rem;
            color: var(--farm-tan);
        }

        .nav-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            justify-content: center;
        }

        .nav-tab {
            background: linear-gradient(180deg, var(--farm-cream) 0%, var(--farm-tan) 100%);
            border: 3px solid var(--farm-brown);
            border-radius: 12px;
            padding: 8px 14px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--farm-brown);
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 var(--wood-brown);
        }

        .nav-tab:hover { transform: translateY(-2px); }
        .nav-tab:active, .nav-tab.active {
            transform: translateY(2px);
            box-shadow: none;
            background: linear-gradient(180deg, var(--farm-tan) 0%, var(--farm-brown) 100%);
            color: var(--farm-cream);
        }

        .content-area {
            background: linear-gradient(180deg, var(--farm-cream) 0%, #FFF5E6 100%);
            border-radius: 20px;
            padding: 15px;
            min-height: 65vh;
            border: 4px solid var(--wood-brown);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        .tab-content { display: none; }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-overview {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border-radius: 12px;
            padding: 12px;
            border: 3px solid var(--hunger-orange);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-around;
        }

        .stat-item { text-align: center; }
        .stat-item .stat-icon { font-size: 1.4rem; }
        .stat-item .stat-value { font-size: 1.1rem; font-weight: 700; color: var(--farm-brown); }
        .stat-item .stat-name { font-size: 0.65rem; color: #666; }

        /* ==================== FERRET CARD ==================== */
        .ferret-card {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFE4B5 100%);
            border-radius: 18px;
            padding: 15px;
            margin-bottom: 15px;
            border: 3px solid #8B4513;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ferret-habitat {
            background: linear-gradient(180deg, #E8F5E9 0%, #A5D6A7 50%, #81C784 100%);
            border-radius: 12px;
            height: 130px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
            border: 2px solid #66BB6A;
        }

        .ferret-habitat::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: repeating-linear-gradient(90deg, transparent 0px, transparent 6px, #4CAF50 6px, #4CAF50 8px, transparent 8px, transparent 14px);
        }

        /* ==================== ANIMATED FERRET ==================== */
        .ferret {
            position: absolute;
            width: 90px;
            height: 55px;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            transition: left 2s ease-in-out;
        }

        .ferret.face-left { transform: translateX(-50%) scaleX(-1); }

        .ferret-body {
            position: absolute;
            width: 60px;
            height: 24px;
            border-radius: 30px 35px 22px 20px;
            bottom: 10px;
            left: 12px;
            animation: breathe 2.5s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.06); }
        }

        .ferret-head {
            position: absolute;
            width: 30px;
            height: 24px;
            border-radius: 50% 55% 45% 40%;
            bottom: 16px;
            left: 0;
            animation: head-bob 4s ease-in-out infinite;
        }

        @keyframes head-bob {
            0%, 100% { transform: rotate(0deg); }
            30% { transform: rotate(-6deg) translateY(-2px); }
            70% { transform: rotate(4deg) translateY(1px); }
        }

        .ferret-snout {
            position: absolute;
            width: 16px;
            height: 12px;
            background: #FFF8E1;
            border-radius: 50% 60% 50% 40%;
            bottom: 18px;
            left: -8px;
        }

        .ferret-nose {
            position: absolute;
            width: 7px;
            height: 6px;
            background: #E91E63;
            border-radius: 50%;
            bottom: 22px;
            left: -10px;
            animation: nose-twitch 3s ease-in-out infinite;
        }

        @keyframes nose-twitch {
            0%, 85%, 100% { transform: scale(1); }
            90% { transform: scale(1.1); }
            95% { transform: scale(0.95); }
        }

        .ferret-eye {
            position: absolute;
            width: 9px;
            height: 9px;
            background: #1a1a1a;
            border-radius: 50%;
            bottom: 24px;
            animation: blink 4s ease-in-out infinite;
        }

        .ferret-eye.left { left: 5px; }
        .ferret-eye.right { left: 16px; }

        .ferret-eye::after {
            content: '';
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
        }

        @keyframes blink {
            0%, 42%, 58%, 100% { transform: scaleY(1); }
            45%, 55% { transform: scaleY(0.1); }
        }

        .ferret-ear {
            position: absolute;
            width: 12px;
            height: 14px;
            border-radius: 50% 50% 35% 35%;
            bottom: 34px;
        }

        .ferret-ear.left { left: 3px; transform: rotate(-20deg); }
        .ferret-ear.right { left: 18px; transform: rotate(15deg); }

        .ferret-ear {
            animation: ear-twitch 6s ease-in-out infinite;
        }

        .ferret-ear.right { animation-delay: 0.5s; }

        @keyframes ear-twitch {
            0%, 85%, 100% { transform: rotate(-20deg); }
            88% { transform: rotate(-30deg); }
            91% { transform: rotate(-15deg); }
            94% { transform: rotate(-25deg); }
        }

        .ferret-mask {
            position: absolute;
            width: 20px;
            height: 12px;
            background: #5D4037;
            border-radius: 40% 50% 50% 40%;
            bottom: 18px;
            left: 3px;
            opacity: 0.8;
        }

        .ferret-leg {
            position: absolute;
            width: 9px;
            height: 14px;
            border-radius: 5px 5px 7px 7px;
            bottom: 0;
        }

        .ferret-leg.front-left { left: 20px; }
        .ferret-leg.front-right { left: 34px; }
        .ferret-leg.back-left { left: 52px; }
        .ferret-leg.back-right { left: 64px; }

        .ferret-tail {
            position: absolute;
            width: 28px;
            height: 12px;
            border-radius: 12px;
            bottom: 14px;
            right: -2px;
            transform-origin: left center;
            animation: tail-wag 2s ease-in-out infinite;
        }

        @keyframes tail-wag {
            0%, 100% { transform: rotate(-8deg); }
            50% { transform: rotate(12deg); }
        }

        /* Walking animation */
        .ferret.walking .ferret-leg.front-left, .ferret.walking .ferret-leg.back-right {
            animation: leg-walk 0.25s ease-in-out infinite;
        }
        .ferret.walking .ferret-leg.front-right, .ferret.walking .ferret-leg.back-left {
            animation: leg-walk 0.25s ease-in-out infinite 0.125s;
        }

        @keyframes leg-walk {
            0%, 100% { height: 14px; bottom: 0; }
            50% { height: 10px; bottom: 4px; }
        }

        /* Ferret Colors */
        .ferret.sable .ferret-body, .ferret.sable .ferret-head, .ferret.sable .ferret-ear, .ferret.sable .ferret-tail { background: #8B7355; }
        .ferret.sable .ferret-leg { background: #5D4037; }

        .ferret.albino .ferret-body, .ferret.albino .ferret-head, .ferret.albino .ferret-ear, .ferret.albino .ferret-tail { background: #FFF8E1; }
        .ferret.albino .ferret-leg { background: #FFECB3; }
        .ferret.albino .ferret-mask { opacity: 0; }
        .ferret.albino .ferret-eye { background: #E91E63; }

        .ferret.chocolate .ferret-body, .ferret.chocolate .ferret-head, .ferret.chocolate .ferret-ear, .ferret.chocolate .ferret-tail { background: #6D4C41; }
        .ferret.chocolate .ferret-leg { background: #4E342E; }

        .ferret.cinnamon .ferret-body, .ferret.cinnamon .ferret-head, .ferret.cinnamon .ferret-ear, .ferret.cinnamon .ferret-tail { background: #D7A86E; }
        .ferret.cinnamon .ferret-leg { background: #A67C52; }
        .ferret.cinnamon .ferret-mask { background: #8D6E63; }

        .ferret.silver .ferret-body, .ferret.silver .ferret-head, .ferret.silver .ferret-ear, .ferret.silver .ferret-tail { background: #9E9E9E; }
        .ferret.silver .ferret-leg { background: #757575; }
        .ferret.silver .ferret-mask { background: #424242; }

        .ferret.champagne .ferret-body, .ferret.champagne .ferret-head, .ferret.champagne .ferret-ear, .ferret.champagne .ferret-tail { background: #F5DEB3; }
        .ferret.champagne .ferret-leg { background: #DEB887; }
        .ferret.champagne .ferret-mask { background: #A1887F; opacity: 0.6; }

        /* ==================== FERRET STATES ==================== */
        
        /* Sleeping */
        .ferret.sleeping .ferret-body { animation: sleep-breathe 3.5s ease-in-out infinite; }
        @keyframes sleep-breathe {
            0%, 100% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(1.12) scaleX(0.96); }
        }

        .ferret.sleeping .ferret-head { animation: none; transform: rotate(-12deg) translateY(6px); }
        .ferret.sleeping .ferret-eye { animation: none; transform: scaleY(0.1); }
        .ferret.sleeping .ferret-tail { animation: sleep-tail 5s ease-in-out infinite; }
        @keyframes sleep-tail {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(5deg); }
        }

        .sleep-zzz {
            position: absolute;
            top: 8px;
            right: 25%;
            font-size: 1.3rem;
            animation: float-zzz 2.5s ease-in-out infinite;
        }

        @keyframes float-zzz {
            0%, 100% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-12px) scale(1.15); opacity: 0.6; }
        }

        /* Eating */
        .ferret.eating .ferret-head { animation: eat-bob 0.25s ease-in-out infinite; }
        @keyframes eat-bob {
            0%, 100% { transform: translateY(0) rotate(12deg); }
            50% { transform: translateY(4px) rotate(18deg); }
        }

        .food-bowl {
            position: absolute;
            bottom: 8px;
            left: 15%;
            width: 28px;
            height: 14px;
            background: linear-gradient(180deg, #FF8A65 0%, #E64A19 100%);
            border-radius: 4px 4px 12px 12px;
            display: none;
        }

        .food-bowl::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 4px;
            width: 20px;
            height: 7px;
            background: #8D6E63;
            border-radius: 50%;
        }

        .ferret.eating ~ .food-bowl { display: block; animation: food-appear 0.3s ease; }
        @keyframes food-appear { from { transform: scale(0); } to { transform: scale(1); } }

        /* Playing */
        .ferret.playing { animation: play-bounce 0.4s ease-in-out infinite; }
        @keyframes play-bounce {
            0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            25% { transform: translateX(-50%) translateY(-18px) rotate(-8deg); }
            50% { transform: translateX(-50%) translateY(0) rotate(0deg); }
            75% { transform: translateX(-50%) translateY(-12px) rotate(8deg); }
        }

        .ferret.playing .ferret-tail { animation: play-tail 0.15s ease-in-out infinite; }
        @keyframes play-tail {
            0%, 100% { transform: rotate(-25deg); }
            50% { transform: rotate(25deg); }
        }

        .play-stars {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            display: none;
        }

        .ferret.playing ~ .play-stars { display: block; }

        .play-star {
            position: absolute;
            font-size: 1.1rem;
            animation: star-pop 0.7s ease-out infinite;
        }

        .play-star:nth-child(1) { top: 15%; left: 20%; animation-delay: 0s; }
        .play-star:nth-child(2) { top: 25%; right: 20%; animation-delay: 0.2s; }
        .play-star:nth-child(3) { top: 10%; left: 50%; animation-delay: 0.4s; }

        @keyframes star-pop {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.3) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        /* Status indicators */
        .hunger-indicator, .sad-indicator {
            position: absolute;
            top: 8px;
            font-size: 1.1rem;
            display: none;
        }

        .hunger-indicator { left: 12px; animation: indicator-pulse 1.2s ease-in-out infinite; }
        .sad-indicator { right: 12px; animation: indicator-drip 2s ease-in-out infinite; }

        .ferret.hungry ~ .hunger-indicator { display: block; }
        .ferret.sad ~ .sad-indicator { display: block; }

        @keyframes indicator-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.25); }
        }

        @keyframes indicator-drip {
            0%, 100% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(6px); opacity: 0.5; }
        }

        /* ==================== FERRET INFO ==================== */
        .ferret-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .ferret-name-tag {
            background: linear-gradient(135deg, var(--farm-brown) 0%, #6D4C41 100%);
            color: var(--farm-cream);
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .ferret-personality {
            background: var(--farm-tan);
            color: var(--farm-brown);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .ferret-age {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-bar {
            background: rgba(0,0,0,0.08);
            border-radius: 8px;
            padding: 6px 8px;
        }

        .stat-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--farm-brown);
            margin-bottom: 4px;
        }

        .stat-track {
            height: 10px;
            background: #DDD;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .stat-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.4s ease, background 0.4s ease;
            position: relative;
        }

        .stat-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
        }

        .stat-fill.high { background: linear-gradient(90deg, #81C784, #4CAF50); }
        .stat-fill.medium { background: linear-gradient(90deg, #FFB74D, #FF9800); }
        .stat-fill.low { background: linear-gradient(90deg, #EF9A9A, #F44336); }

        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .action-btn {
            padding: 8px 6px;
            border: none;
            border-radius: 10px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .action-btn .btn-icon { font-size: 1.2rem; }

        .btn-feed { background: linear-gradient(180deg, #FFCC80, var(--hunger-orange)); color: white; box-shadow: 0 3px 0 #BF360C; }
        .btn-play { background: linear-gradient(180deg, #F8BBD9, #E91E63); color: white; box-shadow: 0 3px 0 #880E4F; }
        .btn-rest { background: linear-gradient(180deg, #B39DDB, #673AB7); color: white; box-shadow: 0 3px 0 #311B92; }
        .btn-adopt-out { background: linear-gradient(180deg, #90CAF9, #2196F3); color: white; box-shadow: 0 3px 0 #0D47A1; }

        .action-btn:hover { transform: translateY(-2px); }
        .action-btn:active { transform: translateY(2px); box-shadow: none; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        /* ==================== FARM ==================== */
        .seed-selection {
            background: var(--farm-tan);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px dashed var(--farm-brown);
        }

        .seed-selection h3 {
            font-size: 0.95rem;
            color: var(--farm-brown);
            margin-bottom: 8px;
            text-align: center;
        }

        .seed-options {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .seed-btn {
            background: var(--farm-cream);
            border: 2px solid var(--farm-brown);
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }

        .seed-btn:hover { background: white; transform: translateY(-2px); }
        .seed-btn.selected { background: var(--grass-green); color: white; border-color: #388E3C; }

        .seed-btn .seed-icon { font-size: 1.3rem; }
        .seed-btn .seed-name { font-size: 0.7rem; font-weight: 600; display: block; }
        .seed-btn .seed-time { font-size: 0.6rem; opacity: 0.7; }

        .farm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .farm-plot {
            aspect-ratio: 1;
            background: linear-gradient(180deg, var(--soil-brown) 0%, #3E2723 100%);
            border-radius: 12px;
            border: 3px solid #4E342E;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3);
        }

        .farm-plot:hover { transform: scale(1.05); }
        .farm-plot.empty::after { content: '+'; font-size: 1.8rem; color: rgba(255,255,255,0.3); }

        .farm-plot .crop-icon {
            font-size: 1.8rem;
            animation: grow-pop 0.4s ease;
        }

        @keyframes grow-pop {
            0% { transform: scale(0) rotate(-10deg); }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .farm-plot .progress-ring {
            width: 80%;
            height: 6px;
            background: rgba(0,0,0,0.4);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .farm-plot .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #66BB6A, #4CAF50);
            transition: width 0.4s ease;
        }

        .farm-plot.ready { animation: ready-glow 1s ease-in-out infinite; }
        @keyframes ready-glow {
            0%, 100% { box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3), 0 0 0 0 rgba(76,175,80,0.6); }
            50% { box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3), 0 0 15px 5px rgba(76,175,80,0.4); }
        }

        .farm-plot.ready .crop-icon { animation: ready-bounce 0.5s ease-in-out infinite; }
        @keyframes ready-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .inventory {
            background: linear-gradient(135deg, #EFEBE9 0%, #D7CCC8 100%);
            border-radius: 12px;
            padding: 12px;
            border: 3px solid var(--wood-brown);
        }

        .inventory h3 { font-size: 0.95rem; color: var(--farm-brown); margin-bottom: 8px; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .inventory-item {
            background: var(--farm-cream);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            border: 2px solid var(--farm-tan);
        }

        .inventory-item .item-icon { font-size: 1.3rem; }
        .inventory-item .item-count { font-size: 0.9rem; font-weight: 700; color: var(--farm-brown); }

        /* ==================== ADOPTION ==================== */
        .adoption-section { margin-bottom: 20px; }

        .section-title {
            font-size: 1.1rem;
            color: var(--farm-brown);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px dotted var(--farm-tan);
        }

        .shelter-card {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: 12px;
            padding: 10px;
            border: 2px solid #1976D2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shelter-ferret-preview {
            width: 65px;
            height: 50px;
            background: linear-gradient(180deg, #E8F5E9 0%, #A5D6A7 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .mini-ferret {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%) scale(0.55);
            width: 90px;
            height: 55px;
        }

        .shelter-info { flex: 1; }
        .shelter-info h4 { font-size: 0.95rem; color: #0D47A1; }
        .shelter-info p { font-size: 0.75rem; color: #1565C0; }

        .adopt-btn {
            background: linear-gradient(180deg, #66BB6A, #43A047);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 0 2px 0 #2E7D32;
            transition: all 0.15s ease;
        }

        .adopt-btn:hover { transform: translateY(-2px); }
        .adopt-btn:active { transform: translateY(2px); box-shadow: none; }

        .adopted-card {
            background: linear-gradient(135deg, #FCE4EC 0%, #F8BBD9 100%);
            border: 2px solid #E91E63;
        }

        .adopted-card h4 { color: #880E4F !important; }
        .adopted-card p { color: #AD1457 !important; }

        .empty-state { text-align: center; padding: 25px; color: #999; }
        .empty-state .emoji { font-size: 2.5rem; margin-bottom: 8px; }

        /* ==================== DATA TAB ==================== */
        .data-section { display: flex; flex-direction: column; gap: 12px; }

        .data-card {
            background: linear-gradient(135deg, #FAFAFA 0%, #EEEEEE 100%);
            border-radius: 12px;
            padding: 12px;
            border: 2px solid #BDBDBD;
        }

        .data-card h3 { font-size: 0.95rem; color: #424242; margin-bottom: 8px; }

        .data-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.15s ease;
        }

        .data-btn:last-child { margin-bottom: 0; }

        .btn-backup { background: linear-gradient(180deg, #81D4FA, #039BE5); color: white; box-shadow: 0 3px 0 #01579B; }
        .btn-restore { background: linear-gradient(180deg, #A5D6A7, #43A047); color: white; box-shadow: 0 3px 0 #1B5E20; }
        .btn-reset { background: linear-gradient(180deg, #EF9A9A, #E53935); color: white; box-shadow: 0 3px 0 #B71C1C; }

        .data-btn:hover { transform: translateY(-2px); }
        .data-btn:active { transform: translateY(2px); box-shadow: none; }

        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--farm-cream);
            border-radius: 20px;
            padding: 20px;
            max-width: 350px;
            width: 100%;
            border: 4px solid var(--farm-brown);
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
            animation: modal-pop 0.25s ease;
        }

        @keyframes modal-pop {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { font-size: 1.3rem; color: var(--farm-brown); margin-bottom: 12px; text-align: center; }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--farm-tan);
            border-radius: 8px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .modal-input:focus { outline: none; border-color: var(--farm-brown); }

        .modal-buttons { display: flex; gap: 8px; }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-family: 'Fredoka', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-cancel { background: #E0E0E0; color: #666; }
        .modal-btn-confirm { background: linear-gradient(180deg, #81C784, #43A047); color: white; box-shadow: 0 2px 0 #2E7D32; }

        .feed-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .feed-option {
            background: var(--farm-tan);
            border: 2px solid var(--farm-brown);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .feed-option:hover:not(.disabled) { transform: scale(1.05); background: var(--farm-cream); }
        .feed-option.disabled { opacity: 0.4; cursor: not-allowed; }

        .feed-option .food-icon { font-size: 1.8rem; }
        .feed-option .food-name { font-size: 0.85rem; font-weight: 600; color: var(--farm-brown); }
        .feed-option .food-count { font-size: 0.7rem; color: #666; }
        .feed-option .food-boost { font-size: 0.65rem; color: #4CAF50; margin-top: 2px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--farm-brown);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 2000;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            max-width: 90%;
            text-align: center;
        }

        .toast.show { transform: translateX(-50%) translateY(0); }

        .file-input { display: none; }

        .no-ferrets { text-align: center; padding: 30px 15px; color: var(--farm-brown); }
        .no-ferrets .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
        .no-ferrets h3 { margin-bottom: 8px; }
        .no-ferrets p { font-size: 0.85rem; opacity: 0.7; }

        .goodbye-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            z-index: 3000;
            animation: float-away 2s ease forwards;
            pointer-events: none;
        }

        @keyframes float-away {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -200%) scale(0.5); }
        }

        .install-prompt {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid var(--grass-green);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
            text-align: center;
        }

        .install-prompt.show { display: block; }
        .install-prompt p { font-size: 0.85rem; color: #2E7D32; margin-bottom: 8px; }

        .install-btn {
            background: linear-gradient(180deg, #66BB6A, #43A047);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 0 #2E7D32;
        }

        .dismiss-install {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            margin-left: 8px;
            text-decoration: underline;
            font-size: 0.85rem;
        }

        @media (max-width: 380px) {
            .nav-tab { padding: 6px 10px; font-size: 0.75rem; }
            .header h1 { font-size: 1.5rem; }
            .action-buttons { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="sun"></div>
    <div class="clouds">
        <div class="cloud"></div>
        <div class="cloud"></div>
        <div class="cloud"></div>
    </div>

    <div class="game-container">
        <header class="header">
            <h1>ü¶° Autumn's Ferret Farm ü¶°</h1>
            <p class="subtitle">Care for your fuzzy friends!</p>
        </header>

        <div class="install-prompt" id="installPrompt">
            <p>üì± Install for the best experience!</p>
            <button class="install-btn" id="installBtn">Install App</button>
            <button class="dismiss-install" id="dismissInstall">Not now</button>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="ferrets">ü¶° Ferrets</button>
            <button class="nav-tab" data-tab="farm">üåæ Farm</button>
            <button class="nav-tab" data-tab="adoption">üè† Adopt</button>
            <button class="nav-tab" data-tab="data">üíæ Data</button>
        </nav>

        <main class="content-area">
            <div class="tab-content active" id="ferretsTab">
                <div class="stats-overview">
                    <div class="stat-item">
                        <span class="stat-icon">ü¶°</span>
                        <span class="stat-value" id="ferretCount">0</span>
                        <span class="stat-name">Ferrets</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">üåæ</span>
                        <span class="stat-value" id="totalFood">0</span>
                        <span class="stat-name">Food</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">üíï</span>
                        <span class="stat-value" id="adoptedOut">0</span>
                        <span class="stat-name">Adopted Out</span>
                    </div>
                </div>
                <div id="ferretsList"></div>
            </div>

            <div class="tab-content" id="farmTab">
                <div class="seed-selection">
                    <h3>üå± Select Seeds to Plant</h3>
                    <div class="seed-options">
                        <button class="seed-btn selected" data-seed="carrot">
                            <span class="seed-icon">ü•ï</span>
                            <span class="seed-name">Carrots</span>
                            <span class="seed-time">30s</span>
                        </button>
                        <button class="seed-btn" data-seed="chicken">
                            <span class="seed-icon">üçó</span>
                            <span class="seed-name">Chicken</span>
                            <span class="seed-time">60s</span>
                        </button>
                        <button class="seed-btn" data-seed="egg">
                            <span class="seed-icon">ü•ö</span>
                            <span class="seed-name">Eggs</span>
                            <span class="seed-time">45s</span>
                        </button>
                        <button class="seed-btn" data-seed="treat">
                            <span class="seed-icon">üç¨</span>
                            <span class="seed-name">Treats</span>
                            <span class="seed-time">90s</span>
                        </button>
                    </div>
                </div>
                <div class="farm-grid" id="farmGrid"></div>
                <div class="inventory">
                    <h3>üì¶ Food Storage</h3>
                    <div class="inventory-grid">
                        <div class="inventory-item"><div class="item-icon">ü•ï</div><div class="item-count" id="carrotCount">0</div></div>
                        <div class="inventory-item"><div class="item-icon">üçó</div><div class="item-count" id="chickenCount">0</div></div>
                        <div class="inventory-item"><div class="item-icon">ü•ö</div><div class="item-count" id="eggCount">0</div></div>
                        <div class="inventory-item"><div class="item-icon">üç¨</div><div class="item-count" id="treatCount">0</div></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="adoptionTab">
                <div class="adoption-section">
                    <h3 class="section-title">üè† Ferret Shelter</h3>
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 12px;">Give a loving home to a ferret in need!</p>
                    <div id="shelterFerrets"></div>
                </div>
                <div class="adoption-section">
                    <h3 class="section-title">üíï Happy Adoptions</h3>
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 12px;">Ferrets you've helped find loving families!</p>
                    <div id="adoptedFerrets"></div>
                </div>
            </div>

            <div class="tab-content" id="dataTab">
                <div class="data-section">
                    <div class="data-card">
                        <h3>üíæ Backup & Restore</h3>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Save your progress or restore from backup.</p>
                        <button class="data-btn btn-backup" id="backupBtn">‚¨áÔ∏è Download Backup</button>
                        <button class="data-btn btn-restore" id="restoreBtn">‚¨ÜÔ∏è Restore from File</button>
                        <input type="file" class="file-input" id="restoreInput" accept=".json">
                    </div>
                    <div class="data-card">
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">This will delete ALL your progress!</p>
                        <button class="data-btn btn-reset" id="resetBtn">üóëÔ∏è Reset Everything</button>
                    </div>
                    <div class="data-card">
                        <h3>‚ÑπÔ∏è How to Play</h3>
                        <p style="font-size: 0.8rem; color: #666; line-height: 1.5;">
                            ü¶° <strong>Adopt</strong> ferrets from the shelter<br>
                            üåæ <strong>Grow food</strong> on your farm<br>
                            üçΩÔ∏è <strong>Feed</strong> your ferrets to keep them happy<br>
                            üéÆ <strong>Play</strong> with them for happiness<br>
                            üò¥ <strong>Rest</strong> to restore energy<br>
                            üè† <strong>Find homes</strong> for ferrets you've raised<br>
                            üíæ <strong>Progress saves automatically!</strong>
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="feedModal">
        <div class="modal">
            <h2>üçΩÔ∏è Feed <span id="feedFerretName"></span></h2>
            <div class="feed-options" id="feedOptions"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="closeFeedModal">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="nameModal">
        <div class="modal">
            <h2>ü¶° Name Your New Ferret!</h2>
            <div id="adoptPreview" style="margin-bottom: 12px;"></div>
            <input type="text" class="modal-input" id="ferretNameInput" placeholder="Enter a name..." maxlength="15">
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Personality: <strong id="newFerretPersonality"></strong></p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="cancelAdopt">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmAdopt">Adopt! üíï</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h2 id="confirmTitle">Confirm</h2>
            <p id="confirmMessage" style="margin-bottom: 12px; color: #666;"></p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="confirmCancel">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const CONFIG = {
            TICK_RATE: 1000,
            STAT_DECAY_RATE: 0.12,
            MOVEMENT_INTERVAL: 5000,
            CROPS: {
                carrot: { icon: 'ü•ï', growTime: 30, hungerBoost: 20, name: 'Carrot' },
                chicken: { icon: 'üçó', growTime: 60, hungerBoost: 35, name: 'Chicken' },
                egg: { icon: 'ü•ö', growTime: 45, hungerBoost: 25, name: 'Egg' },
                treat: { icon: 'üç¨', growTime: 90, hungerBoost: 15, happinessBoost: 25, name: 'Treat' }
            },
            PERSONALITIES: [
                { name: 'Playful', emoji: 'üéÆ', hungerDecay: 1.2, happinessDecay: 0.8, energyDecay: 1.3 },
                { name: 'Lazy', emoji: 'üò¥', hungerDecay: 0.7, happinessDecay: 1.0, energyDecay: 0.6 },
                { name: 'Curious', emoji: 'üîç', hungerDecay: 1.0, happinessDecay: 0.9, energyDecay: 1.1 },
                { name: 'Mischievous', emoji: 'üòà', hungerDecay: 1.1, happinessDecay: 1.1, energyDecay: 1.2 },
                { name: 'Cuddly', emoji: 'ü§ó', hungerDecay: 0.9, happinessDecay: 0.6, energyDecay: 0.8 },
                { name: 'Adventurous', emoji: 'üåü', hungerDecay: 1.3, happinessDecay: 1.0, energyDecay: 1.4 }
            ],
            COLORS: ['sable', 'albino', 'chocolate', 'cinnamon', 'silver', 'champagne'],
            PLOT_COUNT: 6,
            SHELTER_REFRESH: 90000
        };

        const DB_NAME = 'AutumnsFerretFarm';
        const DB_VERSION = 2;
        const STORE_NAME = 'gameData';

        let gameState = {
            ferrets: [],
            inventory: { carrot: 5, chicken: 2, egg: 3, treat: 1 },
            farm: [],
            shelter: [],
            adoptedOut: [],
            stats: { totalAdoptedOut: 0 },
            lastUpdate: Date.now()
        };

        let db = null;
        let selectedSeed = 'carrot';
        let pendingAdoption = null;
        let confirmCallback = null;
        let feedingFerretId = null;
        let ferretMovementTimers = {};

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveGame() {
            if (!db) return;
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                gameState.lastUpdate = Date.now();
                store.put({ id: 'save', data: gameState }).onsuccess = () => resolve();
            });
        }

        async function loadGame() {
            if (!db) return null;
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get('save');
                request.onsuccess = () => resolve(request.result?.data || null);
            });
        }

        function generateFerret(name = null) {
            const personality = CONFIG.PERSONALITIES[Math.floor(Math.random() * CONFIG.PERSONALITIES.length)];
            const color = CONFIG.COLORS[Math.floor(Math.random() * CONFIG.COLORS.length)];
            return {
                id: Date.now() + Math.random(),
                name: name || generateFerretName(),
                personality, color,
                hunger: 70 + Math.random() * 25,
                happiness: 70 + Math.random() * 25,
                energy: 70 + Math.random() * 25,
                health: 100,
                age: 0,
                isResting: false,
                isEating: false,
                isPlaying: false,
                position: 50,
                faceLeft: Math.random() > 0.5,
                created: Date.now()
            };
        }

        function generateFerretName() {
            const names = ['Noodle', 'Slinky', 'Bandit', 'Cookie', 'Ziggy', 'Pepper', 'Cocoa', 'Maple', 
                'Hazel', 'Peanut', 'Biscuit', 'Mochi', 'Waffles', 'Nugget', 'Sprout', 'Cinnamon', 
                'Butterscotch', 'Toffee', 'Whiskers', 'Fuzzy', 'Snickers', 'Caramel', 'Pretzel', 'Churro',
                'Noodles', 'Boo', 'Shadow', 'Rocket', 'Luna', 'Ginger', 'Oreo', 'Pumpkin'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function createFerretHTML(ferret, mini = false) {
            const scale = mini ? 'transform: translateX(-50%) scale(0.55);' : 'transform: translateX(-50%);';
            const stateClasses = [
                ferret.color,
                ferret.isResting ? 'sleeping' : '',
                ferret.isEating ? 'eating' : '',
                ferret.isPlaying ? 'playing' : '',
                ferret.hunger < 30 ? 'hungry' : '',
                ferret.happiness < 30 ? 'sad' : '',
                ferret.faceLeft && !ferret.isResting ? 'face-left' : ''
            ].filter(Boolean).join(' ');
            
            return `
                <div class="ferret ${stateClasses}" style="left: ${ferret.position || 50}%; ${scale}" data-id="${ferret.id}">
                    <div class="ferret-body"></div>
                    <div class="ferret-head"></div>
                    <div class="ferret-snout"></div>
                    <div class="ferret-nose"></div>
                    <div class="ferret-mask"></div>
                    <div class="ferret-eye left"></div>
                    <div class="ferret-eye right"></div>
                    <div class="ferret-ear left"></div>
                    <div class="ferret-ear right"></div>
                    <div class="ferret-leg front-left"></div>
                    <div class="ferret-leg front-right"></div>
                    <div class="ferret-leg back-left"></div>
                    <div class="ferret-leg back-right"></div>
                    <div class="ferret-tail"></div>
                </div>
                ${ferret.isResting ? '<div class="sleep-zzz">üí§</div>' : ''}
                ${ferret.isPlaying ? '<div class="play-stars"><span class="play-star">‚≠ê</span><span class="play-star">‚ú®</span><span class="play-star">‚≠ê</span></div>' : ''}
                <div class="food-bowl"></div>
                <div class="hunger-indicator">üçñ‚ùì</div>
                <div class="sad-indicator">üíß</div>
            `;
        }

        function updateFerretStats() {
            const now = Date.now();
            const elapsed = (now - gameState.lastUpdate) / 1000;

            gameState.ferrets.forEach(ferret => {
                if (ferret.isEating || ferret.isPlaying) return;

                if (!ferret.isResting) {
                    ferret.hunger -= CONFIG.STAT_DECAY_RATE * elapsed * ferret.personality.hungerDecay;
                    ferret.happiness -= CONFIG.STAT_DECAY_RATE * elapsed * ferret.personality.happinessDecay;
                    ferret.energy -= CONFIG.STAT_DECAY_RATE * elapsed * ferret.personality.energyDecay * 0.4;
                } else {
                    ferret.energy += CONFIG.STAT_DECAY_RATE * elapsed * 1.5;
                    ferret.happiness -= CONFIG.STAT_DECAY_RATE * elapsed * 0.15;
                }

                ferret.hunger = Math.max(0, Math.min(100, ferret.hunger));
                ferret.happiness = Math.max(0, Math.min(100, ferret.happiness));
                ferret.energy = Math.max(0, Math.min(100, ferret.energy));

                const avgStats = (ferret.hunger + ferret.happiness + ferret.energy) / 3;
                if (avgStats < 25) ferret.health -= CONFIG.STAT_DECAY_RATE * elapsed * 0.25;
                else if (avgStats > 70) ferret.health += CONFIG.STAT_DECAY_RATE * elapsed * 0.1;
                ferret.health = Math.max(0, Math.min(100, ferret.health));

                ferret.age += elapsed / 60;
            });

            gameState.farm.forEach(plot => {
                if (plot.crop && !plot.ready) {
                    plot.progress += elapsed;
                    if (plot.progress >= CONFIG.CROPS[plot.crop].growTime) plot.ready = true;
                }
            });

            gameState.lastUpdate = now;
        }

        function feedFerret(ferretId, food) {
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret || gameState.inventory[food] <= 0) return false;

            gameState.inventory[food]--;
            ferret.isEating = true;
            ferret.isResting = false;
            renderFerrets();

            setTimeout(() => {
                ferret.hunger += CONFIG.CROPS[food].hungerBoost;
                if (CONFIG.CROPS[food].happinessBoost) ferret.happiness += CONFIG.CROPS[food].happinessBoost;
                ferret.hunger = Math.min(100, ferret.hunger);
                ferret.happiness = Math.min(100, ferret.happiness);
                ferret.isEating = false;
                showToast(`${ferret.name} loved the ${CONFIG.CROPS[food].name}! üòã`);
                saveGame();
                renderFerrets();
                updateOverviewStats();
            }, 2000);
            return true;
        }

        function playWithFerret(ferretId) {
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret) return false;
            if (ferret.energy < 15) { showToast(`${ferret.name} is too tired! üò¥`); return false; }

            ferret.isPlaying = true;
            ferret.isResting = false;
            renderFerrets();

            setTimeout(() => {
                ferret.happiness += 25;
                ferret.energy -= 20;
                ferret.hunger -= 8;
                ferret.happiness = Math.min(100, ferret.happiness);
                ferret.energy = Math.max(0, ferret.energy);
                ferret.hunger = Math.max(0, ferret.hunger);
                ferret.isPlaying = false;
                showToast(`${ferret.name} had so much fun! üéâ`);
                saveGame();
                renderFerrets();
            }, 2500);
            return true;
        }

        function toggleRest(ferretId) {
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret) return;
            ferret.isResting = !ferret.isResting;
            ferret.isPlaying = false;
            ferret.isEating = false;
            showToast(ferret.isResting ? `${ferret.name} is napping... üí§` : `${ferret.name} woke up! üåü`);
            saveGame();
            renderFerrets();
        }

        function moveFerret(ferretId) {
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret || ferret.isResting || ferret.isEating || ferret.isPlaying) return;

            const newPos = 15 + Math.random() * 70;
            ferret.faceLeft = newPos < ferret.position;
            
            const ferretEl = document.querySelector(`.ferret[data-id="${ferretId}"]`);
            if (ferretEl) {
                ferretEl.classList.add('walking');
                ferretEl.style.left = newPos + '%';
                if (ferret.faceLeft) ferretEl.classList.add('face-left');
                else ferretEl.classList.remove('face-left');
                setTimeout(() => ferretEl.classList.remove('walking'), 2000);
            }
            ferret.position = newPos;
        }

        function plantCrop(plotIndex) {
            if (gameState.farm[plotIndex].crop) return;
            gameState.farm[plotIndex] = { crop: selectedSeed, progress: 0, ready: false };
            showToast(`Planted ${CONFIG.CROPS[selectedSeed].icon}!`);
            saveGame();
            renderFarm();
        }

        function harvestCrop(plotIndex) {
            const plot = gameState.farm[plotIndex];
            if (!plot.ready) return;
            gameState.inventory[plot.crop]++;
            gameState.farm[plotIndex] = { crop: null, progress: 0, ready: false };
            showToast(`Harvested ${CONFIG.CROPS[plot.crop].icon}!`);
            saveGame();
            renderFarm();
            updateOverviewStats();
        }

        function adoptFerret(shelterIndex) {
            const ferret = gameState.shelter[shelterIndex];
            if (!ferret) return;
            pendingAdoption = { ferret, index: shelterIndex };
            document.getElementById('newFerretPersonality').textContent = `${ferret.personality.emoji} ${ferret.personality.name}`;
            document.getElementById('ferretNameInput').value = ferret.name;
            document.getElementById('adoptPreview').innerHTML = `
                <div style="background: linear-gradient(180deg, #E8F5E9 0%, #A5D6A7 100%); border-radius: 10px; height: 70px; position: relative; overflow: hidden;">
                    ${createFerretHTML({...ferret, position: 50}, true)}
                </div>`;
            document.getElementById('nameModal').classList.add('active');
            document.getElementById('ferretNameInput').focus();
        }

        function confirmAdoption() {
            if (!pendingAdoption) return;
            const name = document.getElementById('ferretNameInput').value.trim();
            if (!name) { showToast('Please enter a name!'); return; }

            pendingAdoption.ferret.name = name;
            pendingAdoption.ferret.position = 50;
            gameState.ferrets.push(pendingAdoption.ferret);
            gameState.shelter.splice(pendingAdoption.index, 1);

            document.getElementById('nameModal').classList.remove('active');
            showToast(`Welcome ${name} to the family! üéâüíï`);
            startFerretMovement(pendingAdoption.ferret.id);
            pendingAdoption = null;
            saveGame();
            renderAll();
        }

        function putUpForAdoption(ferretId) {
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret) return;
            showConfirm('üíï Find a New Home?', `Find a loving family for ${ferret.name}?`, () => {
                if (ferretMovementTimers[ferretId]) { clearInterval(ferretMovementTimers[ferretId]); delete ferretMovementTimers[ferretId]; }
                gameState.ferrets = gameState.ferrets.filter(f => f.id != ferretId);
                gameState.adoptedOut.push({ name: ferret.name, personality: ferret.personality, color: ferret.color, adoptedDate: Date.now() });
                gameState.stats.totalAdoptedOut++;
                showGoodbyeAnimation(ferret);
                saveGame();
                renderAll();
            });
        }

        function showGoodbyeAnimation(ferret) {
            const el = document.createElement('div');
            el.className = 'goodbye-animation';
            el.innerHTML = 'ü¶°üíïüè†';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
            showToast(`${ferret.name} found a loving home! üè†üíï`);
        }

        function refreshShelter() {
            gameState.shelter = [];
            const count = 2 + Math.floor(Math.random() * 2);
            for (let i = 0; i < count; i++) {
                const ferret = generateFerret();
                ferret.position = 50;
                gameState.shelter.push(ferret);
            }
            saveGame();
            renderShelter();
        }

        function startFerretMovement(ferretId) {
            if (ferretMovementTimers[ferretId]) clearInterval(ferretMovementTimers[ferretId]);
            ferretMovementTimers[ferretId] = setInterval(() => moveFerret(ferretId), CONFIG.MOVEMENT_INTERVAL + Math.random() * 3000);
        }

        function startAllFerretMovements() {
            gameState.ferrets.forEach(f => startFerretMovement(f.id));
        }

        function renderFerrets() {
            const container = document.getElementById('ferretsList');
            if (gameState.ferrets.length === 0) {
                container.innerHTML = `<div class="no-ferrets"><div class="icon">ü¶°</div><h3>No Ferrets Yet!</h3><p>Visit the Adopt tab to find your first fuzzy friend!</p></div>`;
                return;
            }

            container.innerHTML = gameState.ferrets.map(ferret => `
                <div class="ferret-card">
                    <div class="ferret-habitat">${createFerretHTML(ferret)}</div>
                    <div class="ferret-info-row">
                        <span class="ferret-name-tag">${ferret.name}</span>
                        <span class="ferret-personality">${ferret.personality.emoji} ${ferret.personality.name}</span>
                    </div>
                    <div class="ferret-age">Age: ${Math.floor(ferret.age)} min ‚Ä¢ ${ferret.color}</div>
                    <div class="stats-grid">
                        <div class="stat-bar"><div class="stat-label">üçñ Hunger</div><div class="stat-track"><div class="stat-fill ${getStatLevel(ferret.hunger)}" style="width: ${ferret.hunger}%"></div></div></div>
                        <div class="stat-bar"><div class="stat-label">üíñ Happy</div><div class="stat-track"><div class="stat-fill ${getStatLevel(ferret.happiness)}" style="width: ${ferret.happiness}%"></div></div></div>
                        <div class="stat-bar"><div class="stat-label">‚ö° Energy</div><div class="stat-track"><div class="stat-fill ${getStatLevel(ferret.energy)}" style="width: ${ferret.energy}%"></div></div></div>
                        <div class="stat-bar"><div class="stat-label">üíö Health</div><div class="stat-track"><div class="stat-fill ${getStatLevel(ferret.health)}" style="width: ${ferret.health}%"></div></div></div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-feed" onclick="openFeedModal('${ferret.id}')" ${ferret.isEating || ferret.isPlaying ? 'disabled' : ''}><span class="btn-icon">üçΩÔ∏è</span>Feed</button>
                        <button class="action-btn btn-play" onclick="playWithFerret('${ferret.id}')" ${ferret.energy < 15 || ferret.isEating || ferret.isPlaying || ferret.isResting ? 'disabled' : ''}><span class="btn-icon">üéÆ</span>Play</button>
                        <button class="action-btn btn-rest" onclick="toggleRest('${ferret.id}')" ${ferret.isEating || ferret.isPlaying ? 'disabled' : ''}><span class="btn-icon">${ferret.isResting ? '‚òÄÔ∏è' : 'üò¥'}</span>${ferret.isResting ? 'Wake' : 'Rest'}</button>
                        <button class="action-btn btn-adopt-out" onclick="putUpForAdoption('${ferret.id}')"><span class="btn-icon">üè†</span>Adopt</button>
                    </div>
                </div>
            `).join('');
        }

        function getStatLevel(value) {
            if (value > 60) return 'high';
            if (value > 30) return 'medium';
            return 'low';
        }

        function renderFarm() {
            const container = document.getElementById('farmGrid');
            container.innerHTML = gameState.farm.map((plot, i) => {
                if (!plot.crop) return `<div class="farm-plot empty" onclick="plantCrop(${i})"></div>`;
                const crop = CONFIG.CROPS[plot.crop];
                const progress = Math.min(100, (plot.progress / crop.growTime) * 100);
                return `<div class="farm-plot ${plot.ready ? 'ready' : ''}" onclick="${plot.ready ? `harvestCrop(${i})` : ''}">
                    <span class="crop-icon">${crop.icon}</span>
                    ${!plot.ready ? `<div class="progress-ring"><div class="progress-fill" style="width: ${progress}%"></div></div>` : '<span style="font-size: 0.65rem; color: #4CAF50; font-weight: bold;">TAP!</span>'}
                </div>`;
            }).join('');

            document.getElementById('carrotCount').textContent = gameState.inventory.carrot;
            document.getElementById('chickenCount').textContent = gameState.inventory.chicken;
            document.getElementById('eggCount').textContent = gameState.inventory.egg;
            document.getElementById('treatCount').textContent = gameState.inventory.treat;
        }

        function renderShelter() {
            const container = document.getElementById('shelterFerrets');
            if (gameState.shelter.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="emoji">üè†</div><p>No ferrets right now. Check back soon!</p></div>`;
                return;
            }
            container.innerHTML = gameState.shelter.map((f, i) => `
                <div class="shelter-card">
                    <div class="shelter-ferret-preview"><div class="mini-ferret">${createFerretHTML({...f, position: 50}, true)}</div></div>
                    <div class="shelter-info"><h4>${f.name}</h4><p>${f.personality.emoji} ${f.personality.name}</p><p style="font-size: 0.7rem; text-transform: capitalize;">Color: ${f.color}</p></div>
                    <button class="adopt-btn" onclick="adoptFerret(${i})">Adopt! üíï</button>
                </div>
            `).join('');
        }

        function renderAdoptedOut() {
            const container = document.getElementById('adoptedFerrets');
            if (gameState.adoptedOut.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="emoji">üíï</div><p>No ferrets adopted out yet.</p></div>`;
                return;
            }
            container.innerHTML = gameState.adoptedOut.slice().reverse().map(f => `
                <div class="shelter-card adopted-card">
                    <div class="shelter-ferret-preview"><div class="mini-ferret">${createFerretHTML({...f, position: 50}, true)}</div></div>
                    <div class="shelter-info"><h4>${f.name}</h4><p>${f.personality.emoji} ${f.personality.name}</p><p style="font-size: 0.65rem;">Found a home ${formatTimeAgo(f.adoptedDate)}</p></div>
                    <span style="font-size: 1.5rem;">üè†üíï</span>
                </div>
            `).join('');
        }

        function updateOverviewStats() {
            document.getElementById('ferretCount').textContent = gameState.ferrets.length;
            document.getElementById('totalFood').textContent = Object.values(gameState.inventory).reduce((a, b) => a + b, 0);
            document.getElementById('adoptedOut').textContent = gameState.stats.totalAdoptedOut;
        }

        function renderAll() { renderFerrets(); renderFarm(); renderShelter(); renderAdoptedOut(); updateOverviewStats(); }

        function openFeedModal(ferretId) {
            feedingFerretId = ferretId;
            const ferret = gameState.ferrets.find(f => f.id == ferretId);
            if (!ferret) return;
            document.getElementById('feedFerretName').textContent = ferret.name;
            document.getElementById('feedOptions').innerHTML = Object.entries(CONFIG.CROPS).map(([key, crop]) => `
                <div class="feed-option ${gameState.inventory[key] <= 0 ? 'disabled' : ''}" onclick="${gameState.inventory[key] > 0 ? `selectFood('${key}')` : ''}">
                    <div class="food-icon">${crop.icon}</div>
                    <div class="food-name">${crop.name}</div>
                    <div class="food-count">√ó${gameState.inventory[key]}</div>
                    <div class="food-boost">+${crop.hungerBoost}${crop.happinessBoost ? ` +${crop.happinessBoost}üíñ` : ''}</div>
                </div>
            `).join('');
            document.getElementById('feedModal').classList.add('active');
        }

        function selectFood(food) {
            if (feedingFerretId && gameState.inventory[food] > 0) {
                feedFerret(feedingFerretId, food);
                document.getElementById('feedModal').classList.remove('active');
                feedingFerretId = null;
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }

        function formatTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'just now';
        }

        function downloadBackup() {
            const data = JSON.stringify(gameState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ferret-farm-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup saved! üíæ');
        }

        function restoreBackup(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.ferrets || !data.inventory || !data.farm) throw new Error('Invalid');
                    Object.keys(ferretMovementTimers).forEach(id => clearInterval(ferretMovementTimers[id]));
                    ferretMovementTimers = {};
                    gameState = data;
                    gameState.lastUpdate = Date.now();
                    gameState.adoptedOut = gameState.adoptedOut || [];
                    gameState.stats = gameState.stats || { totalAdoptedOut: 0 };
                    gameState.shelter = gameState.shelter || [];
                    gameState.ferrets.forEach(f => { if (!f.position) f.position = 50; f.isEating = false; f.isPlaying = false; });
                    await saveGame();
                    startAllFerretMovements();
                    renderAll();
                    showToast('Restored! üéâ');
                } catch (err) { showToast('Invalid file! üò¢'); console.error(err); }
            };
            reader.readAsText(file);
        }

        function resetGame() {
            showConfirm('‚ö†Ô∏è Reset?', 'Delete ALL progress? Cannot be undone!', async () => {
                Object.keys(ferretMovementTimers).forEach(id => clearInterval(ferretMovementTimers[id]));
                ferretMovementTimers = {};
                gameState = { ferrets: [], inventory: { carrot: 5, chicken: 2, egg: 3, treat: 1 }, farm: [], shelter: [], adoptedOut: [], stats: { totalAdoptedOut: 0 }, lastUpdate: Date.now() };
                initializeFarm();
                refreshShelter();
                await saveGame();
                renderAll();
                showToast('Reset complete! üå±');
            });
        }

        function initializeFarm() {
            gameState.farm = [];
            for (let i = 0; i < CONFIG.PLOT_COUNT; i++) gameState.farm.push({ crop: null, progress: 0, ready: false });
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
                });
            });

            document.querySelectorAll('.seed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.seed-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedSeed = btn.dataset.seed;
                });
            });

            document.getElementById('closeFeedModal').addEventListener('click', () => document.getElementById('feedModal').classList.remove('active'));
            document.getElementById('cancelAdopt').addEventListener('click', () => { document.getElementById('nameModal').classList.remove('active'); pendingAdoption = null; });
            document.getElementById('confirmAdopt').addEventListener('click', confirmAdoption);
            document.getElementById('ferretNameInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmAdoption(); });
            document.getElementById('confirmCancel').addEventListener('click', () => { document.getElementById('confirmModal').classList.remove('active'); confirmCallback = null; });
            document.getElementById('confirmOk').addEventListener('click', () => { document.getElementById('confirmModal').classList.remove('active'); if (confirmCallback) { confirmCallback(); confirmCallback = null; } });
            document.getElementById('backupBtn').addEventListener('click', downloadBackup);
            document.getElementById('restoreBtn').addEventListener('click', () => document.getElementById('restoreInput').click());
            document.getElementById('restoreInput').addEventListener('change', (e) => { if (e.target.files[0]) { restoreBackup(e.target.files[0]); e.target.value = ''; } });
            document.getElementById('resetBtn').addEventListener('click', resetGame);
            document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', (e) => { if (e.target === o) o.classList.remove('active'); }));
        }

        let deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installPrompt').classList.add('show'); });
        document.getElementById('installBtn')?.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('installPrompt').classList.remove('show'); } });
        document.getElementById('dismissInstall')?.addEventListener('click', () => document.getElementById('installPrompt').classList.remove('show'));

        function gameLoop() { updateFerretStats(); renderFerrets(); renderFarm(); saveGame(); }

        async function init() {
            try {
                await initDB();
                const saved = await loadGame();
                if (saved) {
                    gameState = saved;
                    gameState.adoptedOut = gameState.adoptedOut || [];
                    gameState.stats = gameState.stats || { totalAdoptedOut: 0 };
                    gameState.shelter = gameState.shelter || [];
                    gameState.ferrets.forEach(f => { if (!f.position) f.position = 50; f.isEating = false; f.isPlaying = false; });
                }
                if (gameState.farm.length === 0) initializeFarm();
                if (gameState.shelter.length === 0) refreshShelter();
                setupEventListeners();
                renderAll();
                startAllFerretMovements();
                setInterval(gameLoop, CONFIG.TICK_RATE);
                setInterval(refreshShelter, CONFIG.SHELTER_REFRESH);
                if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(console.error);
                console.log('ü¶° Autumn\'s Ferret Farm loaded!');
            } catch (err) { console.error('Init failed:', err); showToast('Error loading. Please refresh.'); }
        }

        init();
    </script>
</body>
</html>
